# Cайт для Telegram WebApp 
### [Техническая задача "DiamondGaming"](https://teletype.in/@sxm/r7AsIau4JYHsqqE)

## Оглавление:
- [Технологии](#технологии)
- [Установка и запуск](#установка-и-запуск)
- [Описание работы](#описание-работы)
- [Удаление](#удаление)

## Технологии
<details>
  <summary>Подробнее</summary>
    <p><strong>Языки программирования:</strong> python, javascript</p>
    <p><strong>Фреймворк и модули:</strong> Django, djangorestframework, django-channels</p>
    <p><strong>Базы данных и инструменты работы с ними:</strong> PostgreSQL, SQLite, Redis</p>
    <p><strong>Отложенные задачи:</strong> Celery</p>  
    <p><strong>CI/CD:</strong> Docker Hub, Docker Compose, uWSGI, daphne, Nginx</p>  
</details>

## Установка и запуск

<details>
  <summary>Предварительные условия</summary>
  <p>Предполагается, что пользователь:</p>
  
  - Создал аккаунт [DockerHub](https://hub.docker.com/).
  - Установил [Docker](https://docs.docker.com/engine/install/) и [Docker Compose](https://docs.docker.com/compose/install/) на локальной машине или удаленном сервере, где проект будет запускаться в контейнерах. Проверить наличие можно выполнив команды:
    
  `docker --version && docker-compose --version`
  
</details>
<details>
  <summary>Запуск</summary>
  
  <p><strong>!!! Для пользователей Windows обязательно выполнить команду:</strong></p>
  
    `git config --global core.autocrlf false`
    
  <p>иначе файл start.sh при клонировании будет бракован</p>
  
  1. Клонируйте репозиторий с GitHub и введите данные для переменных окружения (значения даны для примера, некоторые можно оставить по типу DB*):
    
    git clone https://github.com/s0ull877/DIAMOND.git && \
    cd DIAMOND/app && \
    cp .env_example .env && \
    nano .env

  2. Из корневой директории проекта выполните команду:

    docker compose -f casino_infra/docker-compose.yml up -d --build

  Проект будет развернут в шести docker-контейнерах (db, asgi, wsgi, redis, celery, nginx) по адресу `http:/host_ip/`
  
  3. Остановить docker и удалить контейнеры можно командой из корневой директории проекта:

    docker compose -f infra/docker-compose.yml down
  
  Если также необходимо удалить тома базы данных, статики и медиа:

    docker compose -f infra/docker-compose.yml down -v

</details>

---

При первом запуске будут автоматически произведены следующие действия:

  - выполнены миграции

  - собрана статика

  - создан суперюзер с учетными данными:


## Описание работы

Проект представляет из себя сайт/webapp, переход в который осущетсвляется через inline button в телеграм боте.<br>
Требования к сайту:

  - Реализация API для коннекта бота к вебапп и вывода актуальных действий пользователя в обоих сервисах

  - Реализация онлайн игр из ТЗ: Аукцион, Крестики-Нолики, Джекпот

  - Сайт должен иметь 3 языка: Английский, Украинский, Русский.

### Users app
В ходе реализации проекта, т.к. регистрация пользователей происходит в боте, принято решение создавать [кастомного юзера](https://github.com/s0ull877/DIAMOND/blob/master/app/users/models.py).<br>
В целях автоматизации развертывания проекта в Docker, создана простейшая [django команда](https://github.com/s0ull877/DIAMOND/blob/master/app/users/management/commands/create_superuser.py) для создания суперюзера.<br>
Для модели users был создан [кастомный валидатор](https://github.com/s0ull877/DIAMOND/blob/master/app/users/validators.py), т.к. пароль пользователя является пин-код от 6 цифр.<br>
В приложении users написаны контроллеры рендеринга профиля, топа пользователей, настроек приложения и главной страницы, а также контроллера для ajax запросов, для смены языка и темы приложения.<br>
Изменение темы осуществляется через встраивание переменной в сессию пользователя и добавление файла темы через условный оператор в django templates.<br>
Перевод языка приложения осуществлялся через trans блок django template. Все переводы храняться в дирректориях locale/ у приложений.<br>
### Ballance app
Данное приложение отвечается за кошелек пользователя и транзакции совершенные с польщовательскими кошельками.<br>
Модель `UserWallet` создается автоматически при создании пользователя с помощью `@receiver(models.signals.post_save, sender=User)`.<br>
Модель `BallanceTransaction` создана для логирования изменений балланса пользователя, создание обьектов транзакции осущетсвляется в методе модели `UserWallet.transaction`.<br>
В этом же методе происходит проверка состояния поля ballance, который не может быть меньше $0.
### Auction app
Приложения в котором реализована игра "аукцион" имеет 2 модели `Auction` и `AuctionBet`.
На странице выбора аукциона имеется статичная часть перехода на официальный аукцион, рендер официального аукциона выведет в отдельный контроллер `diamond_auction_view`.<br>
Вывод активных аукцион и актуальная информация о них происходит за счет ежесекундных запросов на `AuctionsConsumer(AsyncWebsocketConsumer)`, который возвращает html код и отрисовывается через js.<br>
При переходе на страницу аукциона, действует `AuctionConsumer(WebsocketConsumer)`, который запускает таймер при начале аукциона, возвращает актуальный статус таймера для новых игроков и отправляет на js данные о ставках и аукциона<br>
После окончания таймера победитель вознаграждается при помощи models.signal с передачей кастомного аргумента.
### Jackpot app
Приложения в котором реализована игра "джекпот" имеет 2 модели `Jackpot` и `JackpotBet`.
Джекпот реализован так же как и Аукцион, однако решение о победе совершается через celery.
Для определения победителя написан метод модели `Jackpot.set_winner`
### Tictactoe app
Для отрисовки карты используется приображения двумерного массива(0 - свободное пространство, 1 - крестик, 2 - нолик)
### Bot_endpoints app
Обычная апишка на создание транзакций и юзеров

## Удаление
Для удаления проекта выполните следующие действия:

  `cd .. && rm -fr DIAMOND && deactivate`

[Оглавление](#оглавление)

## <a id="#автор">Автор</a>
[Radmir Galiullin](https://github.com/s0ull877)
